<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BGCP_lab appointment system</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      html, body, #root { height: 100%; }
      .cell-hr { height: 64px; }
      @media (max-width: 640px) {
        .cell-hr { height: 56px; }
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const GAS_WEBAPP_URL_DEFAULT = "https://script.google.com/macros/s/AKfycbzW7VnHZttj7I-VPyNEp0R2MGharbAM2OsyijYO-wW4e8tZPMtPNYC1gfHz5-86-h3rFA/exec";
      const GAS_WEBAPP_URL =
        new URL(location.href).searchParams.get("gas") || GAS_WEBAPP_URL_DEFAULT;

      const { useEffect, useMemo, useState, useRef } = React;

      const fmtDate = (d) => { d = new Date(d); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; };
      const t2m = (t) => { const [h,m] = String(t).split(":").map(Number); return h*60 + (m||0); };
      const m2t = (m) => `${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
      const roundTo = (x, s=15) => Math.round(x/s)*s;
      const clampTo = (a,b,min=0,max=24*60)=>[Math.max(min,a),Math.min(max,b)];
      const isOverlap = (a1,a2,b1,b2)=>a1<b2 && b1<a2;
      function getWeekStart(date){
        const d = new Date(date);
        d.setDate(d.getDate() - d.getDay());
        d.setHours(0,0,0,0);
        return d;
      }
      async function sha256Hex(str){
        const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
        return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      function randomSalt(n=16){ const a=new Uint8Array(n); crypto.getRandomValues(a); return [...a].map(b=>b.toString(16).padStart(2,"0")).join(""); }

      // ===== GAS API =====
      async function apiGetUserFromSheet(email){
        const u = new URL(GAS_WEBAPP_URL); u.searchParams.set("action","getUser"); u.searchParams.set("email", email);
        const res = await fetch(u); return res.json().catch(()=>null);
      }
      async function apiRegisterToSheet({name,email,password}){
        const salt = randomSalt();
        const hash = await sha256Hex(password + ":" + salt);
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST",
          headers: {"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"register", name, email, salt, hash })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiRequestReset(email){
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"request_reset", email })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiConfirmReset(email, code, newPassword){
        const newSalt = randomSalt();
        const newHash = await sha256Hex(newPassword + ":" + newSalt);
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"confirm_reset", email, code, newSalt, newHash })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiListInstruments(){
        const u = new URL(GAS_WEBAPP_URL); u.searchParams.set("action","list_instruments");
        const res = await fetch(u); return res.json().catch(()=>[]);
      }
      async function apiUpsertInstrument(requester, instrument){
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"upsert_instrument", requester, instrument })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiDeleteInstrument(requester, id){
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"delete_instrument", requester, id })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiListReservations(fromISO,toISO,instrumentId){
        const u = new URL(GAS_WEBAPP_URL);
        u.searchParams.set("action","list_reservations");
        u.searchParams.set("from", fromISO);
        u.searchParams.set("to",   toISO);
        if(instrumentId) u.searchParams.set("instrumentId", instrumentId);
        const res = await fetch(u); return res.json().catch(()=>[]);
      }
      async function apiCreateReservation(requester,resv){
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"create_reservation", requester, res:resv })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiDeleteReservation(requester,id){
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ action:"delete_reservation", requester, id })
        });
        return res.json().catch(()=>({ok:false}));
      }

      function App(){
        const [instruments,setInstruments] = useState([]);
        const [selected,setSelected]       = useState("");
        const [reservations,setReservations] = useState([]);
        const [weekStart,setWeekStart]     = useState(getWeekStart(new Date()));
        const [toast,setToast]             = useState(null);
        const [quick,setQuick]             = useState(null); // {date,start,end,user?}
        const [user,setUser]               = useState(null);
        const [busy,setBusy]               = useState(false);
        const pollRef = useRef(null);

        const weekDates = useMemo(()=>Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)),[weekStart]);
        const weekRange = useMemo(()=>({from:fmtDate(weekStart), to:fmtDate(new Date(weekStart.getTime()+6*86400000))}),[weekStart]);
        const weekdays  = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        const hours     = Array.from({length:24},(_,i)=>i);

        async function loadInstruments(){
          const data = await apiListInstruments();
          setInstruments(Array.isArray(data)?data:[]);
          if(!selected && Array.isArray(data) && data.length) setSelected(data[0].id);
        }
        async function loadReservations(){
          const data = await apiListReservations(weekRange.from, weekRange.to, selected || "");
          setReservations(Array.isArray(data)?data:[]);
        }

        useEffect(()=>{ loadInstruments(); },[]);
        useEffect(()=>{ if(selected) loadReservations(); },[weekRange.from, weekRange.to, selected]);
        useEffect(()=>{
          if(pollRef.current) clearInterval(pollRef.current);
          pollRef.current = setInterval(()=>{ if(selected) loadReservations(); }, 15000);
          return ()=> { if(pollRef.current) clearInterval(pollRef.current); };
        },[selected, weekRange.from, weekRange.to]);

        // 將清單按「本地日期」分組（後端已回 localDate，但也保險重算）
        const mapByDate = useMemo(()=>{
          const m = {};
          for(const r of reservations){
            const d = new Date(r.startISO);
            const k = fmtDate(d);
            (m[k]=m[k]||[]).push(r);
          }
          for(const k in m){
            m[k].sort((a,b)=> new Date(a.startISO) - new Date(b.startISO));
          }
          return m;
        },[reservations]);

        // auth
        async function register(){
          const emailRaw = prompt("Register Email:"); if(!emailRaw) return;
          const email = emailRaw.trim().toLowerCase();
          const exist = await apiGetUserFromSheet(email);
          if(exist && exist.email){
            setToast({t:"error",m:"This email is already registered. Please sign in or use Forgot password."});
            return;
          }
          const name  = (prompt("Name:") || email.split("@")[0]).trim();
          const pw    = (prompt("Set password:") || "admin").trim();
          const r = await apiRegisterToSheet({name,email,password:pw});
          if(!r?.ok){
            const msg = r?.reason==="exists" ? "This email is already registered." : "Failed to write to Google Sheet.";
            setToast({t:"error",m:msg}); return;
          }
          setUser(null);
          setToast({t:"ok",m:"Registration successful. Please sign in."});
        }
        async function login(){
          const email = String(prompt("Email:")||"").trim().toLowerCase();
          const pw    = String(prompt("Password:")||"").trim();
          const s = await apiGetUserFromSheet(email);
          if(!s || !s.salt || !s.hash){ setToast({t:"error",m:"Email or password incorrect."}); return; }
          const calc = await sha256Hex(pw+":"+s.salt);
          if(calc !== s.hash){ setToast({t:"error",m:"Email or password incorrect."}); return; }
          setUser({email, name:s.name||email.split("@")[0], isAdmin: !!s.isAdmin});
          setToast({t:"ok",m:"Signed in."});
        }
        function logout(){ setUser(null); }
        async function forgotPassword(){
          const email = String(prompt("Enter your email:")||"").trim().toLowerCase(); if(!email) return;
          const r1 = await apiRequestReset(email); if(!r1?.ok){ setToast({t:"error",m:"Failed to send verification code."}); return; }
          const code = String(prompt("Enter the 6-digit code sent to your email:")||"").trim(); if(!code) return;
          const newPass = String(prompt("New password:")||"").trim(); if(!newPass) return;
          const r2 = await apiConfirmReset(email, code, newPass); if(!r2?.ok){ setToast({t:"error",m:"Code invalid or expired."}); return; }
          setToast({t:"ok",m:"Password reset. Please sign in with the new password."});
        }

        const listFor = (dateISO) => (mapByDate[dateISO]||[]).filter(r=>!selected || r.instrumentId===selected);

        function hasConflictLocal(startISO, endISO){
          const a1 = new Date(startISO).getTime();
          const a2 = new Date(endISO).getTime();
          const dayKey = fmtDate(new Date(startISO));
          for(const r of listFor(dayKey)){
            const b1 = new Date(r.startISO).getTime();
            const b2 = new Date(r.endISO).getTime();
            if(a1 < b2 && b1 < a2) return true;
          }
          return false;
        }

        function buildISO(dateStr, timeStr){
          // 將使用者本地的 YYYY-MM-DD + HH:mm 組成 Date，再 toISOString()
          const d = new Date(`${dateStr}T${timeStr}:00`);
          return d.toISOString();
        }

        async function addReservation(r){
          if(!user) return setToast({t:"error",m:"Please sign in first."});
          if(!selected) return setToast({t:"error",m:"Please select an instrument."});

          const startISO = buildISO(r.date, r.start);
          const endISO   = buildISO(r.date, r.end);

          if(hasConflictLocal(startISO, endISO)){
            setToast({t:"error",m:"Time conflict. Pick another slot."});
            return;
          }

          setBusy(true);
          const payload = {
            instrumentId: selected,
            startISO, endISO,
            userEmail: user.email, userName: r.user || user.name
          };
          const res = await apiCreateReservation(user.email, payload);
          setBusy(false);

          if(!res?.ok){
            const msg = res?.reason==="conflict" ? "Time conflict. Pick another slot." : "Failed to write to Google Sheet.";
            setToast({t:"error",m:msg});
            return;
          }
          await loadReservations();
          setQuick(null);
          setToast({t:"ok",m:"Booking created."});
        }

        async function removeReservation(id){
          if(!user) return;
          const r = await apiDeleteReservation(user.email, id);
          if(!r?.ok){ setToast({t:"error",m:"Delete failed."}); return; }
          await loadReservations();
          setToast({t:"ok",m:"Booking removed."});
        }

        function onCalendarClick({dateISO,yRatio}){
          if(!selected) return setToast({t:"error",m:"Please select an instrument."});
          const minutesFromStart = Math.floor((24*60) * yRatio);
          let s = roundTo(minutesFromStart, 15), e=s+60; [s,e]=clampTo(s,e);
          setQuick({date:dateISO, start:m2t(s), end:m2t(e), user:(user?.name||"")});
        }

        return (
          <div className="min-h-screen">
            <header className="bg-white border-b sticky top-0 z-40">
              <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2">
                <h1 className="text-xl font-bold mr-auto">BGCP_lab appointment system</h1>

                {!user ? (
                  <>
                    <button className="px-3 py-1 border rounded" onClick={register}>Register</button>
                    <button className="px-3 py-1 border rounded" onClick={login}>Sign in</button>
                    <button className="px-3 py-1 border rounded" onClick={forgotPassword}>Forgot password</button>
                  </>
                ) : (
                  <>
                    <span className="text-sm text-slate-600">
                      {user.name} · {user.email} {user.isAdmin && "(admin)"}
                    </span>
                    {user.isAdmin && (
                      <div className="flex gap-2 flex-wrap">
                        <button className="px-3 py-1 border rounded" onClick={async ()=>{
                          const name = prompt("Instrument name:"); if(!name) return;
                          const r = await apiUpsertInstrument(user.email, { name });
                          if(!r?.ok) return setToast({t:"error",m:"Failed to add instrument."});
                          setToast({t:"ok",m:"Instrument added."});
                          await loadInstruments();
                        }}>Add instrument</button>
                      </div>
                    )}
                    <button className="px-3 py-1 border rounded" onClick={logout}>Sign out</button>
                  </>
                )}

                <select
                  className="px-2 py-1 border rounded w-full sm:w-auto"
                  value={selected}
                  onChange={e=>setSelected(e.target.value)}
                >
                  {instruments.map(i=>(
                    <option key={i.id} value={i.id}>{i.name}</option>
                  ))}
                </select>
              </div>

              <div className="bg-slate-50 border-t">
                <div className="max-w-7xl mx-auto px-4 py-2 flex flex-wrap items-center gap-2 text-sm">
                  <div className="flex items-center rounded-xl border overflow-hidden">
                    <button onClick={()=>setWeekStart(d=>new Date(d.getTime()-7*86400000))} className="px-3 py-1 hover:bg-slate-100">← Prev</button>
                    <div className="px-3 py-1 text-sm bg-slate-50 border-x">
                      {weekRange.from} ~ {weekRange.to}
                    </div>
                    <button onClick={()=>setWeekStart(d=>new Date(d.getTime()+7*86400000))} className="px-3 py-1 hover:bg-slate-100">Next →</button>
                    <button onClick={()=>setWeekStart(getWeekStart(new Date()))} className="px-3 py-1 hover:bg-slate-100">This week</button>
                  </div>
                  <button className="ml-auto px-3 py-1 border rounded" onClick={()=>apiListReservations(weekRange.from, weekRange.to, selected).then(d=>setReservations(d))}>Refresh</button>
                </div>
              </div>
            </header>

            {/* Calendar */}
            <main className="max-w-7xl mx-auto p-4">
              <div className="bg-white border rounded-2xl overflow-hidden">
                <div className="grid grid-cols-8 border-b bg-slate-50 text-sm">
                  <div className="p-2 text-center text-slate-500">Time</div>
                  {weekDates.map((d,idx)=>(
                    <div key={idx} className="p-2 text-center font-medium">
                      <div className="text-slate-500 text-xs">{["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]}</div>
                      <div>{fmtDate(d)}</div>
                    </div>
                  ))}
                </div>

                <div className="grid grid-cols-8 text-sm">
                  <div className="border-r bg-slate-50 select-none">
                    {hours.map(h=>(
                      <div key={h} className="cell-hr border-t px-2 py-1 text-right text-slate-500">
                        {String(h).padStart(2,'0')}:00
                      </div>
                    ))}
                  </div>

                  {weekDates.map((d,idx)=>{
                    const dateISO = fmtDate(d);
                    const list = (mapByDate[dateISO]||[]).filter(r=>!selected || r.instrumentId===selected);
                    return (
                      <div
                        key={idx}
                        className="border-l relative cursor-crosshair"
                        onClick={(e)=>{
                          const rect=e.currentTarget.getBoundingClientRect();
                          const y=e.clientY-rect.top;
                          const ratio=Math.max(0,Math.min(1,y/rect.height));
                          onCalendarClick({dateISO,yRatio:ratio});
                        }}
                      >
                        {hours.map((_,i)=><div key={i} className="cell-hr border-t"></div>)}
                        <div className="absolute inset-0">
                          {list.map(r=>{
                            const sd = new Date(r.startISO);
                            const ed = new Date(r.endISO);
                            const top=((sd.getHours()*60 + sd.getMinutes())/60)*64;
                            const h  =(((ed - sd)/60000)/60)*64;
                            return (
                              <div
                                key={r.id}
                                className="absolute rounded-xl text-xs text-white p-1"
                                style={{top:Math.max(0,top),height:Math.max(24,h),left:4,right:4,background:"#8b5cf6"}}
                              >
                                <div className="font-semibold truncate">Booked</div>
                                <div>
                                  {String(sd.getHours()).padStart(2,'0')}:{String(sd.getMinutes()).padStart(2,'0')}
                                  –
                                  {String(ed.getHours()).padStart(2,'0')}:{String(ed.getMinutes()).padStart(2,'0')}
                                  · {r.userName || (r.userEmail||"").split("@")[0]}
                                </div>
                                {user && (
                                  <div className="mt-1">
                                    <button
                                      className="px-2 py-0.5 border rounded bg-white/20"
                                      onClick={(ev)=>{ev.stopPropagation(); removeReservation(r.id);}}
                                    >
                                      Delete
                                    </button>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </main>

            {/* Quick create dialog */}
            {quick && (
              <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4" onClick={()=>!busy && setQuick(null)}>
                <div className="bg-white rounded-2xl w-full max-w-lg p-4" onClick={(e)=>e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="font-semibold">New booking</h3>
                    <button className="px-2 py-1 text-sm border rounded disabled:opacity-50" onClick={()=>setQuick(null)} disabled={busy}>Close</button>
                  </div>
                  <div className="space-y-3 text-sm">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-slate-600">Date</label>
                        <input type="date" className="w-full px-2 py-1 border rounded" value={quick.date} onChange={e=>setQuick({...quick,date:e.target.value})} disabled={busy}/>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-xs text-slate-600">Start</label>
                          <input type="time" step="900" className="w-full px-2 py-1 border rounded" value={quick.start} onChange={e=>setQuick({...quick,start:e.target.value})} disabled={busy}/>
                        </div>
                        <div>
                          <label className="text-xs text-slate-600">End</label>
                          <input type="time" step="900" className="w-full px-2 py-1 border rounded" value={quick.end} onChange={e=>setQuick({...quick,end:e.target.value})} disabled={busy}/>
                        </div>
                      </div>
                    </div>
                    <div>
                      <label className="text-xs text-slate-600">User</label>
                      <input className="w-full px-2 py-1 border rounded" value={quick.user||""} onChange={e=>setQuick({...quick,user:e.target.value})} disabled={busy}/>
                    </div>

                    {(() => {
                      if(!(quick?.date&&quick?.start&&quick?.end)) return null;
                      const s = new Date(`${quick.date}T${quick.start}:00`).toISOString();
                      const e = new Date(`${quick.date}T${quick.end}:00`).toISOString();
                      return hasConflictLocal(s,e) && <div className="text-rose-600">This time overlaps with an existing booking.</div>;
                    })()}

                    <div className="pt-2 flex items-center gap-2">
                      <button
                        className="px-3 py-2 border rounded bg-slate-900 text-white disabled:opacity-50"
                        onClick={()=> quick.user && addReservation({...quick})}
                        disabled={!quick.user || busy || !(quick?.date&&quick?.start&&quick?.end) || hasConflictLocal(new Date(`${quick.date}T${quick.start}:00`).toISOString(), new Date(`${quick.date}T${quick.end}:00`).toISOString())}
                      >
                        {busy ? "Creating..." : "Create"}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {toast && (
              <div className={`fixed bottom-4 left-1/2 -translate-x-1/2 text-white px-4 py-2 rounded ${toast.t==='ok'?'bg-emerald-600':'bg-rose-600'}`}>
                {toast.m}
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
