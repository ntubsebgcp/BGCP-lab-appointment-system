<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>蕭友晉老師實驗室儀器預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>html, body, #root { height: 100%; }</style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      /***** 基本設定 *****/
      // 你提供的 GAS URL（可用網址參數 ?gas= 覆蓋）
      const GAS_WEBAPP_URL =
        new URL(location.href).searchParams.get("gas") ||
        "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi6NgNBlVWfi0DJtEe9PZN5yQntYvQMYpgaP3LyfhofCieogdU70ENj6R0onPRbtaXaKMtgpxcuMd3ifs8OlCVuomuikBjmz6B8nX19D2HFKQ8VOUQ-tMASAJ87ySg6D3qk0fZRrcjL63JKR7jq6GIbB7KAuCs3hcXFJjncz3Oh6KJM8tAkAAQFXsyOLAt95qvy_bn26kFrwjo1pkfIM_MUhUTdmsvILimRMgKnPoQ0wm87Yw0_mjhFDNpny5GZpLOhoe4N35Xgd6g5iYHCFQIe_BHedtgUFLCxTejv&lib=MBqkAyoSla0_R3qlly_BJbM0j1OmJzjwb";

      const { useEffect, useMemo, useState } = React;
      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
      const fmtDate = (d)=>{d=new Date(d);return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");};
      const t2m=(t)=>{const [h,m]=t.split(":").map(Number);return h*60+m;};
      const m2t=(m)=>`${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
      const isOverlap=(a1,a2,b1,b2)=>a1<b2&&b1<a2;
      const roundTo=(x,s=15)=>Math.round(x/s)*s;
      const clampTo=(a,b,min=8*60,max=20*60)=>[Math.max(min,a),Math.min(max,b)];
      const load=(k,fb)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):fb;}catch(e){return fb}};
      const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
      const ADMIN_WHITELIST = new Set(["renyi0128@gmail.com","yshiau@g.ntu.edu.tw"].map(s=>s.toLowerCase()));

      function weakHash(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return (h>>>0).toString(16);}
      function getWeekStart(date){const d=new Date(date);const day=d.getDay();const diff=(day===0?-6:1)-day;d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
      function escICS(s){return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");}

      /***** GAS API helpers *****/
      async function sha256Hex(str){
        const enc=new TextEncoder();
        const buf=await crypto.subtle.digest("SHA-256", enc.encode(str));
        return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      function randomSalt(n=16){const a=new Uint8Array(n);crypto.getRandomValues(a);return [...a].map(b=>b.toString(16).padStart(2,"0")).join("");}

      async function apiGetUserFromSheet(email){
  	if(!GAS_WEBAPP_URL) return null;
  	const url = GAS_WEBAPP_URL + "?action=getUser&email=" + encodeURIComponent(email);
  	try {
    	  const res = await fetch(url, { method: "GET" });
    	  let payload = null;
    	  // 如果不是 2xx，嘗試讀文字幫你看錯
   	  if (!res.ok) {
      	    const text = await res.text().catch(()=>"(no body)");
            console.log("[GAS getUser] HTTP", res.status, "url=", url, "body=", text);
            return null;
          }
    	  payload = await res.json().catch(()=>null);
    	  console.log("[GAS getUser] 200 OK url=", url, "json=", payload);
    	  return payload;
        } catch (e) {
          console.log("[GAS getUser] network error:", e);
          return null;
        }
      }
      async function apiRegisterToSheet({name,email,password}){
        if(!GAS_WEBAPP_URL) return {ok:false, reason:"no-gas-url"};
        const salt = randomSalt();
        const hash = await sha256Hex(password + ":" + salt);
        const res = await fetch(GAS_WEBAPP_URL, {
          method: "POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ action:"register", name, email, salt, hash })
        });
        const data = await res.json().catch(()=>null);
	console.log("[GAS register] status=", res.status, "data=", data); // <--- 加這行
        if(!res.ok || !data || data.ok!==true) return { ok:false, reason:"gas-error", data };
        return { ok:true, isAdmin: !!data.isAdmin };
      }
      async function apiRequestReset(email){
        if(!GAS_WEBAPP_URL) return {ok:false, reason:"no-gas-url"};
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"request_reset", email })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiConfirmReset(email, code, newPassword){
        if(!GAS_WEBAPP_URL) return {ok:false, reason:"no-gas-url"};
        const newSalt = randomSalt();
        const newHash = await sha256Hex(newPassword + ":" + newSalt);
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"confirm_reset", email, code, newSalt, newHash })
        });
        return res.json().catch(()=>({ok:false}));
      }
      async function apiSetAdmin(requesterEmail, targetEmail, isAdmin){
        if(!GAS_WEBAPP_URL) return {ok:false, reason:"no-gas-url"};
        const res = await fetch(GAS_WEBAPP_URL, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"set_admin", requester: requesterEmail, target: targetEmail, isAdmin })
        });
        return res.json().catch(()=>({ok:false}));
      }

      /***** App *****/
      function App(){
        // 初始資料
        const [instruments,setInstruments]=useState(load('lab_instruments_v1',[
          {id:uid(), name:'GC', location:'漁科所406', color:'#a78bfa', maxMinutes:240},
          {id:uid(), name:'溫室氣體測量儀 (Innova 1512)', location:'水工所307B', color:'#34d399', maxMinutes:120},
        ]));
        const [reservations,setReservations]=useState(load('lab_reservations_v1',[]));
        const [selected,setSelected]=useState(instruments[0]?.id||'');
        const [weekStart,setWeekStart]=useState(getWeekStart(new Date()));
        const [view,setView]=useState('week');
        const [toast,setToast]=useState(null);
        const [quick,setQuick]=useState(null);

        // 使用者/帳號
        function dedupeByEmail(arr){
          const m=new Map(); for(const u of arr){m.set(String(u.email).toLowerCase().trim(), u);} return [...m.values()];
        }
        const [users,setUsers]=useState(()=>dedupeByEmail(load('lab_users_v1',[])));
        const [user,setUser]=useState(load('lab_session_v1',null));

        // persist
        useEffect(()=>save('lab_instruments_v1',instruments),[instruments]);
        useEffect(()=>save('lab_reservations_v1',reservations),[reservations]);
        useEffect(()=>save('lab_session_v1',user),[user]);
        useEffect(()=>{ const clean=dedupeByEmail(users); save('lab_users_v1',clean); if(clean.length!==users.length) setUsers(clean); },[users]);
        useEffect(()=>{ if(!instruments.find(i=>i.id===selected)) setSelected(instruments[0]?.id||''); },[instruments,selected]);

        // 畫面計算
        const weekDates=useMemo(()=>Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)),[weekStart]);
        const filtered=useMemo(()=>reservations.filter(r=>selected? r.instrumentId===selected: false).sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start)),[reservations,selected]);
        const mapByDate=useMemo(()=>{const m={}; for(const r of filtered){(m[r.date]=m[r.date]||[]).push(r);} for(const k in m) m[k].sort((a,b)=>a.start.localeCompare(b.start)); return m;},[filtered]);
        const instr = instruments.find(i=>i.id===selected) || null;

        // 權限
        function canDeleteReservation(current, ownerEmail){
          if(!current) return false;
          if(current.isAdmin) return true;
          return (current.email||"").toLowerCase()===(ownerEmail||"").toLowerCase();
        }

        // 預約 CRUD
        function addReservation(r){
          if(!user) return setToast({t:'error',m:'請先登入帳號'});
          r.email=user.email; r.user=r.user||user.name||user.email.split('@')[0];
          const ins=instruments.find(i=>i.id===r.instrumentId); if(!ins) return setToast({t:'error',m:'請先選擇儀器'});
          if(r.start>=r.end) return setToast({t:'error',m:'結束時間需晚於開始時間'});
          const dur=t2m(r.end)-t2m(r.start); if(ins.maxMinutes && dur>ins.maxMinutes) return setToast({t:'error',m:`此儀器單次最長 ${Math.round(ins.maxMinutes/60)} 小時`});
          const conflicts=reservations.filter(x=>x.instrumentId===r.instrumentId && x.date===r.date && isOverlap(t2m(x.start),t2m(x.end),t2m(r.start),t2m(r.end)));
          if(conflicts.length>0) return setToast({t:'error',m:'時間衝突，請改時段'});
          setReservations(prev=>[...prev,{...r,id:uid(),createdAt:new Date().toISOString()}]); setToast({t:'ok',m:'預約成功'});
        }
        function removeReservation(id){
          const tar=reservations.find(r=>r.id===id);
          if(!canDeleteReservation(user, tar?.email)) return setToast({t:'error',m:'只有建立者或管理員可刪除'});
          setReservations(prev=>prev.filter(r=>r.id!==id)); setToast({t:'ok',m:'已刪除預約'});
        }
        function onCalendarClick({dateISO,yRatio}){
          if(!selected) return setToast({t:'error',m:'請先選擇儀器'});
          const minutesFrom8=Math.floor(12*60*yRatio); let s=roundTo(8*60+minutesFrom8,15), e=s+60; [s,e]=clampTo(s,e); setQuick({date:dateISO,start:m2t(s),end:m2t(e)});
        }

        // 帳號：註冊 / 登入 / 忘記密碼 / 管理員設定
        async function register(){
          const emailRaw = prompt("註冊 Email："); if(!emailRaw) return;
          const email = emailRaw.trim().toLowerCase();
          const name = (prompt("姓名：") || email.split("@")[0]).trim();
          const password = (prompt("設定密碼：") || "admin").trim();

          const gas = await apiRegisterToSheet({ name, email, password });
          if (!gas.ok) { setToast({ t:"error", m:"寫入 Google Sheet 失敗" }); return; }

          const rec = { id: uid(), email, name, hash: weakHash(password), isAdmin: !!gas.isAdmin || ADMIN_WHITELIST.has(email) };
          setUsers(prev => [...prev.filter(u=>u.email!==email), rec]);
          setUser({ id: rec.id, email: rec.email, name: rec.name, isAdmin: rec.isAdmin });
          setToast({ t: "ok", m: "註冊完成" });
        }
        async function login(){
          const email = String(prompt("Email：")||"").trim().toLowerCase();
          const password = String(prompt("密碼：")||"").trim();

          let isAdminFlag = false;
          if (GAS_WEBAPP_URL) {
            try {
              const s = await apiGetUserFromSheet(email);
	      console.log("[login] getUser payload =", s);
              if (s && s.salt && s.hash) {
                const calc = await sha256Hex(password + ":" + s.salt);
                if (calc !== s.hash) { setToast({t:"error",m:"帳號或密碼錯誤（GAS）"}); return; }
                isAdminFlag = !!s.isAdmin;
              }
            } catch(e){}
          }
          const candidates = users.filter(u => String(u.email).toLowerCase().trim() === email);
          const local = candidates.length ? candidates[candidates.length-1] : null;
          if (local && local.hash !== weakHash(password)) { setToast({t:"error",m:"帳號或密碼錯誤（本機）"}); return; }
          const name = local?.name || email.split("@")[0];
          setUser({ id: local?.id || uid(), email, name, isAdmin: isAdminFlag || !!local?.isAdmin || ADMIN_WHITELIST.has(email) });
          setToast({ t:"ok", m:"登入成功" });
        }
        function logout(){ setUser(null); }

        async function forgotPassword(){
          const email = String(prompt("請輸入你的 Email：")||"").trim().toLowerCase(); if(!email) return;
          const r1 = await apiRequestReset(email);
          if (!r1.ok) { setToast({t:"error",m:"送出驗證碼失敗，請確認 Email 是否已註冊"}); return; }
          const code = String(prompt("請輸入寄到信箱的 6 位驗證碼：")||"").trim(); if(!code) return;
          const newPass = String(prompt("請輸入新密碼：")||"").trim(); if(!newPass) return;
          const r2 = await apiConfirmReset(email, code, newPass);
          if (!r2.ok) { setToast({t:"error",m:"驗證失敗或逾時，請重試"}); return; }
          const name = users.find(u=>u.email===email)?.name || email.split("@")[0];
          const rec = { id: uid(), email, name, hash: weakHash(newPass), isAdmin: users.find(u=>u.email===email)?.isAdmin || ADMIN_WHITELIST.has(email) };
          setUsers(prev => [...prev.filter(u=>u.email!==email), rec]);
          setToast({t:"ok",m:"密碼已重設，請用新密碼登入"});
        }

        async function grantAdmin(){
          if(!user?.isAdmin) return;
          const target = String(prompt("輸入要升為管理員的 Email：")||"").trim().toLowerCase(); if(!target) return;
          const r = await apiSetAdmin(user.email, target, true);
          setToast({ t: r.ok ? "ok" : "error", m: r.ok ? "已設定為管理員" : "設定失敗" });
        }
        async function revokeAdmin(){
          if(!user?.isAdmin) return;
          const target = String(prompt("輸入要取消管理員的 Email：")||"").trim().toLowerCase(); if(!target) return;
          const r = await apiSetAdmin(user.email, target, false);
          setToast({ t: r.ok ? "ok" : "error", m: r.ok ? "已取消管理員" : "設定失敗" });
        }

        // 匯出 ICS
        function exportICS(res){
          const dtS=res.date.replace(/-/g,'')+'T'+res.start.replace(':','')+'00';
          const dtE=res.date.replace(/-/g,'')+'T'+res.end.replace(':','')+'00';
          const lines=[
            "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Lab Booking//EN","BEGIN:VEVENT",
            `UID:${res.id}@lab-booking`,`DTSTAMP:${dtS}Z`,`DTSTART:${dtS}`,`DTEND:${dtE}`,
            `SUMMARY:${escICS(res.title|| (instr?.name||'儀器')+' 預約')}`,
            `DESCRIPTION:${escICS('使用者: '+res.user+'\\nEmail: '+(res.email||'')+'\\n用途: '+(res.notes||''))}`,
            `LOCATION:${escICS(instr?.location||'實驗室')}`,"END:VEVENT","END:VCALENDAR"
          ].join("\\n");
          const a=document.createElement('a');
          a.href=URL.createObjectURL(new Blob([lines],{type:'text/calendar'}));
          a.download=`${instr?.name||'instrument'}-${res.date}-${res.start}.ics`; a.click();
        }

        // UI
        const hours=Array.from({length:13},(_,i)=>8+i);

        return (
          <div className="min-h-screen">
            <header className="bg-white border-b sticky top-0 z-40">
              <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-2">
                <h1 className="text-xl font-bold">蕭友晉老師實驗室儀器預約系統</h1>
                <div className="ml-auto flex items-center gap-2">
                  {!user ? (
                    <>
                      <button className="px-3 py-1 border rounded" onClick={register}>註冊</button>
                      <button className="px-3 py-1 border rounded" onClick={login}>登入</button>
                      <button className="px-3 py-1 border rounded" onClick={forgotPassword}>忘記密碼</button>
                    </>
                  ) : (
                    <>
                      <span className="text-sm text-slate-600">{user.name} · {user.email} {user.isAdmin && "（管理員）"}</span>
                      {user.isAdmin && (
                        <>
                          <button className="px-3 py-1 border rounded" onClick={grantAdmin}>賦予管理員</button>
                          <button className="px-3 py-1 border rounded" onClick={revokeAdmin}>取消管理員</button>
                        </>
                      )}
                      <button className="px-3 py-1 border rounded" onClick={logout}>登出</button>
                    </>
                  )}
                  <select className="px-2 py-1 border rounded" value={view} onChange={e=>setView(e.target.value)}>
                    <option value="day">日視圖</option><option value="week">週視圖</option><option value="month">月視圖</option>
                  </select>
                  <select className="px-2 py-1 border rounded" value={selected} onChange={e=>setSelected(e.target.value)}>
                    {instruments.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}
                  </select>
                </div>
              </div>
            </header>

            <main className="max-w-7xl mx-auto p-4">
              {/* 週視圖（簡版） */}
              <div className="bg-white border rounded-2xl overflow-hidden">
                <div className="grid grid-cols-8 border-b bg-slate-50 text-sm">
                  <div className="p-2 text-center text-slate-500">時間</div>
                  {weekDates.map((d,idx)=>(
                    <div key={idx} className="p-2 text-center font-medium">
                      <div className="text-slate-500 text-xs">{['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(d).getDay()]}</div>
                      <div>{fmtDate(d)}</div>
                    </div>
                  ))}
                </div>
                <div className="grid grid-cols-8 text-sm">
                  <div className="border-r bg-slate-50 select-none">
                    {hours.map(h=><div key={h} className="h-16 border-t px-2 py-1 text-right text-slate-500">{String(h).padStart(2,'0')}:00</div>)}
                  </div>
                  {weekDates.map((d,idx)=>{
                    const dateISO=fmtDate(d);
                    const list=mapByDate[dateISO]||[];
                    return (
                      <div key={idx} className="border-l relative cursor-crosshair" onClick={(e)=>{
                        const rect=e.currentTarget.getBoundingClientRect(); const y=e.clientY-rect.top; const ratio=Math.max(0,Math.min(1,y/rect.height)); onCalendarClick({dateISO,yRatio:ratio});
                      }}>
                        {hours.map((_,i)=><div key={i} className="h-16 border-t"></div>)}
                        <div className="absolute inset-0">
                          {list.map(r=>{
                            const top=((t2m(r.start)-8*60)/60)*64; const h=((t2m(r.end)-t2m(r.start))/60)*64;
                            return (
                              <div key={r.id} className="absolute rounded-xl text-xs text-white p-1"
                                style={{top:Math.max(0,top),height:Math.max(24,h),left:4,right:4,background:instr?.color}}>
                                <div className="font-semibold truncate">{r.title||'已預約'}</div>
                                <div>{r.start}–{r.end} ・ {r.user}</div>
                                <div className="mt-1 flex gap-1">
                                  <button className="px-2 py-0.5 border rounded bg-white/20" onClick={(ev)=>{ev.stopPropagation(); exportICS(r);}}>ICS</button>
                                  <button className="px-2 py-0.5 border rounded bg-white/20" onClick={(ev)=>{ev.stopPropagation(); removeReservation(r.id);}}>刪除</button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </main>

            {/* 快速建立 */}
            {quick && (
              <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4" onClick={()=>setQuick(null)}>
                <div className="bg-white rounded-2xl w-full max-w-lg p-4" onClick={(e)=>e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-2"><h3 className="font-semibold">新增預約</h3><button className="px-2 py-1 text-sm border rounded" onClick={()=>setQuick(null)}>關閉</button></div>
                  <div className="space-y-3 text-sm">
                    <div className="grid grid-cols-2 gap-2">
                      <div><label className="text-xs text-slate-600">日期</label><input type="date" className="w-full px-2 py-1 border rounded" value={quick.date} onChange={e=>setQuick({...quick,date:e.target.value})} /></div>
                      <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-xs text-slate-600">開始</label><input type="time" className="w-full px-2 py-1 border rounded" value={quick.start} onChange={e=>setQuick({...quick,start:e.target.value})} /></div>
                        <div><label className="text-xs text-slate-600">結束</label><input type="time" className="w-full px-2 py-1 border rounded" value={quick.end} onChange={e=>setQuick({...quick,end:e.target.value})} /></div>
                      </div>
                    </div>
                    <div><label className="text-xs text-slate-600">使用者</label><input className="w-full px-2 py-1 border rounded" value={quick.user||''} onChange={e=>setQuick({...quick,user:e.target.value})} /></div>
                    <div className="pt-2 flex items-center gap-2">
                      <button className="px-3 py-2 border rounded bg-slate-900 text-white" onClick={()=> quick.user && addReservation({...quick, user: quick.user, instrumentId: selected})} disabled={!quick.user}>建立</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {toast && (<div className={"fixed bottom-4 left-1/2 -translate-x-1/2 text-white px-4 py-2 rounded "+(toast.t==='ok'?'bg-emerald-600':'bg-rose-600')}>{toast.m}</div>)}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
