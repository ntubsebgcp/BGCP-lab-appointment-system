<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>蕭友晉老師實驗室儀器預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>html, body, #root { height: 100%; }</style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
// ================== CONFIG ==================
// 若要把註冊資料同步到 Google Sheet，將 URL 換成你的 Apps Script Web App：
const GAS_WEBAPP_URL = ""; // 例如 "https://script.google.com/macros/s/XXXX/exec"

// ================== Helpers ==================
const { useEffect, useMemo, useState } = React;
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const todayISO = () => new Date().toISOString().slice(0, 10);
function fmtDate(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`; }
const t2m = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
const m2t = (m)=>{ const hh=Math.floor(m/60), mm=m%60; return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`; };
const roundTo = (minutes, step=15)=> Math.round(minutes/step)*step;
const clampToRange = (start,end,min=8*60,max=20*60)=>[Math.max(min,start),Math.min(max,end)];
const isOverlap = (a1,a2,b1,b2)=> a1<b2 && b1<a2;
const load = (k,fb)=>{ try{ const raw=localStorage.getItem(k); return raw?JSON.parse(raw):fb; }catch(e){ return fb; } };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
const ADMIN_EMAILS = new Set(["renyi0128@gmail.com","yshiau@g.ntu.edu.tw"].map(s=>s.toLowerCase()));
const USERS_KEY = "lab_users_v1", SESSION_KEY = "lab_session_v1";

function weakHash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return (h>>>0).toString(16); }
function seedAdmins(){ const users=load(USERS_KEY,[]); const emails=new Set(users.map(u=>u.email.toLowerCase())); let changed=false; for(const e of ADMIN_EMAILS){ if(!emails.has(e)){ users.push({ id:uid(), email:e, name:e.split("@")[0], hash:weakHash("admin"), isAdmin:true }); changed=true; } } if(changed) save(USERS_KEY, users); return users; }
function getUsers(){ return load(USERS_KEY, seedAdmins()); }
function setUsers(arr){ save(USERS_KEY, arr); }
function getSession(){ return load(SESSION_KEY, null); }
function setSession(sess){ save(SESSION_KEY, sess); }
function findUserByEmail(email){ const users=getUsers(); return users.find(u=>u.email.toLowerCase()===(email||"").toLowerCase())||null; }
function canDeleteReservation(currentUser, ownerEmail){ const ce=currentUser?.email?.toLowerCase()||""; const oe=(ownerEmail||"").toLowerCase(); if(!currentUser) return false; if(currentUser.isAdmin) return true; return ce&&oe&&ce===oe; }

async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest("SHA-256", enc.encode(str)); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
function randomSalt(n=16){ const arr=new Uint8Array(n); crypto.getRandomValues(arr); return [...arr].map(b=>b.toString(16).padStart(2,"0")).join(""); }
async function apiRegisterToSheet({name,email,password}){ if(!GAS_WEBAPP_URL) return {ok:false}; const salt=randomSalt(); const hash=await sha256Hex(password+":"+salt); const res=await fetch(GAS_WEBAPP_URL,{method:"POST",headers:{ "Content-Type":"application/json"}, body:JSON.stringify({ action:"register", name, email, salt, hash })}); return res.json().catch(()=>({ok:false})); }
async function apiGetUserFromSheet(email){ if(!GAS_WEBAPP_URL) return null; const res=await fetch(GAS_WEBAPP_URL+"?action=getUser&email="+encodeURIComponent(email)); if(!res.ok) return null; return res.json().catch(()=>null); }

function escapeICS(s){ return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;"); }
function exportICS(res, instrument){ const dtStart=`${res.date.replace(/-/g,"")}T${res.start.replace(":","")}00`; const dtEnd=`${res.date.replace(/-/g,"")}T${res.end.replace(":","")}00`; const lines=[
  "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Lab Booking//EN","BEGIN:VEVENT",
  `UID:${res.id}@lab-booking`,`DTSTAMP:${dtStart}Z`,`DTSTART:${dtStart}`,`DTEND:${dtEnd}`,
  `SUMMARY:${escapeICS(res.title||\`\${instrument?.name||"儀器"} 預約\`)}`,
  `DESCRIPTION:${escapeICS(\`使用者: \${res.user}\nEmail: \${res.email||""}\n用途: \${res.notes||""}\`)}`,
  `LOCATION:${escapeICS(instrument?.location||"實驗室")}`,"END:VEVENT","END:VCALENDAR"
].join("\n"); const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([lines],{type:"text/calendar;charset=utf-8"})); a.download=`${instrument?.name||"instrument"}-${res.date}-${res.start}.ics`; a.click(); }

function exportCSV(reservations, instruments){ const header=["id","instrument","date","start","end","user","email","title","notes","createdAt"]; const byId=Object.fromEntries(instruments.map(i=>[i.id,i])); const rows=reservations.map(r=>[r.id, byId[r.instrumentId]?.name||"", r.date, r.start, r.end, r.user, r.email||"", r.title||"", (r.notes||"").replaceAll(/\n|\r/g," "), r.createdAt]); const csv=[header,...rows].map(arr=>arr.map(v=>`\"\${String(v).replace(/"/g,'""')}\"`).join(",")).join("\n"); const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"})); a.download=\`lab-bookings-\${todayISO()}.csv\`; a.click(); }
function exportJSON(payload){ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"})); a.download=\`lab-booking-backup-\${todayISO()}.json\`; a.click(); }

function getWeekStart(date){ const d=new Date(date); const day=d.getDay(); const diff=(day===0?-6:1)-day; d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d; }

// ================== Main App ==================
function BookingApp(){
  const [instruments,setInstruments]=useState(load("lab_instruments_v1",[
    { id:uid(), name:"GC", location:"漁科所406", color:"#a78bfa", maxMinutes:240 },
    { id:uid(), name:"溫室氣體測量儀 (Innova 1512)", location:"水工所307B", color:"#34d399", maxMinutes:120 },
  ]));
  const [reservations,setReservations]=useState(load("lab_reservations_v1",[]));
  const [selectedInstr,setSelectedInstr]=useState(instruments[0]?.id||"");
  const [weekStart,setWeekStart]=useState(getWeekStart(new Date()));
  const [toast,setToast]=useState(null);
  const [quickCreate,setQuickCreate]=useState(null);
  const [view,setView]=useState("week");

  const [currentUser,setCurrentUser]=useState(getSession());
  const [users,setUsersState]=useState(getUsers());
  useEffect(()=>save("lab_instruments_v1",instruments),[instruments]);
  useEffect(()=>save("lab_reservations_v1",reservations),[reservations]);
  useEffect(()=>setSession(currentUser),[currentUser]);
  useEffect(()=>setUsers(users),[users]);
  useEffect(()=>{ if(!instruments.find(i=>i.id===selectedInstr)) setSelectedInstr(instruments[0]?.id||""); },[instruments,selectedInstr]);

  const weekDates = useMemo(()=> Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)), [weekStart]);
  const filteredReservations = useMemo(()=> reservations.filter(r=> selectedInstr ? r.instrumentId===selectedInstr : false).sort((a,b)=> a.date.localeCompare(b.date)||a.start.localeCompare(b.start)), [reservations, selectedInstr]);
  const mapByDate = useMemo(()=>{ const map={}; for(const r of filteredReservations){ (map[r.date]=map[r.date]||[]).push(r);} for(const k in map) map[k].sort((a,b)=>a.start.localeCompare(b.start)); return map; }, [filteredReservations]);
  const selectedInstrument = instruments.find(i=>i.id===selectedInstr) || null;

  const addReservation = (r)=>{
    if(!currentUser) return setToast({type:"error", msg:"請先登入帳號"});
    r.email=currentUser.email; r.user=r.user||currentUser.name||currentUser.email.split("@")[0];
    const instrument=instruments.find(i=>i.id===r.instrumentId); if(!instrument) return setToast({type:"error", msg:"請先選擇儀器"});
    if(r.start>=r.end) return setToast({type:"error", msg:"結束時間需晚於開始時間"});
    const dur=t2m(r.end)-t2m(r.start); if(instrument.maxMinutes && dur>instrument.maxMinutes) return setToast({type:"error", msg:\`此儀器單次最長 \${Math.round(instrument.maxMinutes/60)} 小時\`});
    const conflicts=reservations.filter(x=> x.instrumentId===r.instrumentId && x.date===r.date && isOverlap(t2m(x.start),t2m(x.end),t2m(r.start),t2m(r.end)));
    if(conflicts.length>0) return setToast({type:"error", msg:"時間衝突，請改時段"});
    setReservations(prev=>[...prev, {...r, id:uid(), createdAt:new Date().toISOString()}]); setToast({type:"success", msg:"預約成功"});
  };
  const removeReservation = (id)=>{
    const target=reservations.find(r=>r.id===id);
    if(!canDeleteReservation(currentUser, target?.email)) return setToast({type:"error", msg:"只有建立者或管理員可刪除"});
    setReservations(prev=> prev.filter(r=>r.id!==id)); setToast({type:"success", msg:"已刪除預約"});
  };
  const editReservation = (id, patch)=>{
    const old=reservations.find(r=>r.id===id); if(!old) return false;
    if(!canDeleteReservation(currentUser, old.email)) { setToast({type:"error", msg:"只有建立者或管理員可編輯"}); return false; }
    const next={...old, ...patch}; if(next.start>=next.end) return setToast({type:"error", msg:"結束時間需晚於開始時間"});
    const instrument=instruments.find(i=>i.id===next.instrumentId);
    const dur=t2m(next.end)-t2m(next.start);
    if(instrument?.maxMinutes && dur>instrument.maxMinutes){ setToast({type:"error", msg:\`此儀器單次最長 \${Math.round(instrument.maxMinutes/60)} 小時\`}); return false; }
    const conflicts=reservations.filter(x=> x.id!==id && x.instrumentId===next.instrumentId && x.date===next.date && isOverlap(t2m(x.start),t2m(x.end),t2m(next.start),t2m(next.end)));
    if(conflicts.length>0) return setToast({type:"error", msg:"時間衝突，請改時段"});
    setReservations(prev=> prev.map(r=> r.id===id ? next : r)); setToast({type:"success", msg:"已更新預約"}); return true;
  };
  const importJSON = (file)=>{
    const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result);
      if(Array.isArray(data.instruments)&&Array.isArray(data.reservations)){ setInstruments(data.instruments); setReservations(data.reservations); setToast({type:"success", msg:"已匯入備份"});} else setToast({type:"error", msg:"格式不正確"});
    }catch(e){ setToast({type:"error", msg:"讀取失敗"});} }; reader.readAsText(file);
  };
  const onCalendarClick = ({dateISO,yRatio})=>{
    if(!selectedInstr) return setToast({type:"error", msg:"請先選擇儀器"});
    const minutesFrom8=Math.floor(12*60*yRatio); let startM=roundTo(8*60+minutesFrom8,15); let endM=startM+60; [startM,endM]=clampToRange(startM,endM); setQuickCreate({date:dateISO,start:m2t(startM),end:m2t(endM)});
  };

  const register = async ({name,email,password})=>{
    email=email.trim().toLowerCase();
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) return setToast({type:"error", msg:"Email 格式不正確"});
    if(findUserByEmail(email)) return setToast({type:"error", msg:"Email 已存在"});
    if(GAS_WEBAPP_URL){ try{ await apiRegisterToSheet({name,email,password}); }catch(e){} }
    const u={ id:uid(), name:(name||"").trim() || email.split("@")[0], email, hash:weakHash(password), isAdmin: ADMIN_EMAILS.has(email) };
    const next=[...users, u]; setUsersState(next); setUsers(next);
    setCurrentUser({ id:u.id, email:u.email, name:u.name, isAdmin:u.isAdmin }); setToast({type:"success", msg:"註冊成功，已自動登入"});
  };
  const login = async ({email,password})=>{
    email=(email||"").trim().toLowerCase();
    let u=findUserByEmail(email);
    if(GAS_WEBAPP_URL){ try{ const rec=await apiGetUserFromSheet(email); if(rec && rec.salt && rec.hash){ const calc=await sha256Hex(password+":"+rec.salt); if(calc!==rec.hash) return setToast({type:"error", msg:"帳號或密碼錯誤"}); if(!u){ u={ id:uid(), name:rec.name||email.split("@")[0], email:rec.email, hash:weakHash(password), isAdmin: ADMIN_EMAILS.has(email) }; const next=[...users,u]; setUsersState(next); setUsers(next);} } }catch(e){} }
    if(!u || u.hash!==weakHash(password)) return setToast({type:"error", msg:"帳號或密碼錯誤"});
    setCurrentUser({ id:u.id, email:u.email, name:u.name, isAdmin:u.isAdmin }); setToast({type:"success", msg:"登入成功"});
  };
  const logout = ()=> setCurrentUser(null);
  const resetPassword=(userId,newPass)=>{ if(!currentUser?.isAdmin) return; const next=users.map(u=>u.id===userId?{...u,hash:weakHash(newPass)}:u); setUsersState(next); setUsers(next); setToast({type:"success", msg:"已重設密碼"}); };
  const removeUser=(userId)=>{ if(!currentUser?.isAdmin) return; const next=users.filter(u=>u.id!==userId); setUsersState(next); setUsers(next); setToast({type:"success", msg:"已刪除帳號"}); };

  return (<div className="min-h-screen bg-slate-50 text-slate-900">
    {!currentUser ? (<AuthGate onRegister={register} onLogin={login} />) : (<>
      <Header
        weekStart={weekStart}
        onPrevWeek={()=>setWeekStart(d=>new Date(d.getTime()-7*86400000))}
        onNextWeek={()=>setWeekStart(d=>new Date(d.getTime()+7*86400000))}
        onToday={()=>setWeekStart(getWeekStart(new Date()))}
        instruments={instruments}
        selectedInstr={selectedInstr}
        setSelectedInstr={setSelectedInstr}
        reservations={reservations}
        onExportCSV={()=>exportCSV(reservations,instruments)}
        onExportJSON={()=>exportJSON({instruments,reservations})}
        onImportJSON={importJSON}
        view={view}
        setView={setView}
        currentUser={currentUser}
        onLogout={logout}
        users={users}
        isAdmin={currentUser.isAdmin}
        onResetPwd={resetPassword}
        onRemoveUser={removeUser}
      />

      <div className="max-w-7xl mx-auto px-4 pb-24 grid md:grid-cols-12 gap-4">
        <main className="md:col-start-2 md:col-span-10">
          {selectedInstr ? (view==="week" ? (
            <WeekCalendar weekDates={weekDates} instrument={selectedInstrument} reservations={filteredReservations} mapByDate={mapByDate} onCalendarClick={onCalendarClick} onDelete={removeReservation} onEdit={editReservation} onExportICS={(r)=>exportICS(r, selectedInstrument)} />
          ) : view==="day" ? (
            <DayCalendar date={weekDates[0]} instrument={selectedInstrument} reservations={mapByDate[fmtDate(weekDates[0])]||[]} onCalendarClick={onCalendarClick} onDelete={removeReservation} onEdit={editReservation} onExportICS={(r)=>exportICS(r, selectedInstrument)} />
          ) : (
            <MonthCalendar anchor={weekStart} instrument={selectedInstrument} reservations={filteredReservations} onDayClick={(dateISO)=>onCalendarClick({dateISO, yRatio:(9-8)/12})} onDelete={removeReservation} onEdit={editReservation} onExportICS={(r)=>exportICS(r, selectedInstrument)} />
          )) : (
            <div className="bg-white border rounded-2xl p-12 text-center text-slate-500">請先於上方選擇儀器後顯示行事曆。</div>
          )}
        </main>
      </div>

      {quickCreate && (<QuickCreate instrument={selectedInstrument} initial={quickCreate} onClose={()=>setQuickCreate(null)} onSubmit={(payload)=>{ addReservation({...payload, instrumentId:selectedInstr}); setQuickCreate(null); }} />)}
      <ToastCtx toast={toast} onClose={()=>setToast(null)} />
      <Footer />
    </>)}
  </div>);
}

function AuthGate({ onRegister, onLogin }){
  const [mode,setMode]=useState("login");
  const [form,setForm]=useState({ name:"", email:"", password:"" });
  return (<div className="min-h-screen grid place-items-center">
    <div className="bg-white border rounded-2xl w-full max-w-md p-6 space-y-4">
      <h1 className="text-xl font-bold">蕭友晉老師實驗室儀器預約系統</h1>
      <div className="flex gap-2">
        <button className={\`px-3 py-2 border rounded-xl \${mode==="login"?"bg-slate-900 text-white":""}\`} onClick={()=>setMode("login")}>登入</button>
        <button className={\`px-3 py-2 border rounded-xl \${mode==="register"?"bg-slate-900 text-white":""}\`} onClick={()=>setMode("register")}>註冊</button>
      </div>
      {mode==="register" && (<div className="text-xs text-slate-600">註冊成功會自動登入。若 Email 屬於管理員名單，將自動成為管理員。</div>)}
      <div className="space-y-3">
        {mode==="register" && (<div><label className="text-xs text-slate-600">姓名</label><input className="w-full px-3 py-2 border rounded-xl" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>)}
        <div><label className="text-xs text-slate-600">Email</label><input className="w-full px-3 py-2 border rounded-xl" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} /></div>
        <div><label className="text-xs text-slate-600">密碼</label><input type="password" className="w-full px-3 py-2 border rounded-xl" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} /></div>
      </div>
      <div className="flex gap-2">
        {mode==="login" ? (<button className="px-3 py-2 border rounded-xl bg-slate-900 text-white" onClick={()=>onLogin({ email:form.email, password:form.password })}>登入</button>)
          : (<button className="px-3 py-2 border rounded-xl bg-slate-900 text-white" onClick={()=>onRegister(form)}>註冊並登入</button>)}
      </div>
    </div>
  </div>);
}

function Header({ weekStart,onPrevWeek,onNextWeek,onToday,instruments,selectedInstr,setSelectedInstr,reservations,onExportCSV,onExportJSON,onImportJSON,view,setView,currentUser,onLogout,users,isAdmin,onResetPwd,onRemoveUser }){
  const end = new Date(weekStart.getTime()+6*86400000);
  const label = \`\${fmtDate(weekStart)} ~ \${fmtDate(end)}\`;
  return (<header className="bg-white border-b sticky top-0 z-40">
    <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <h1 className="text-xl font-bold tracking-tight">蕭友晉老師實驗室儀器預約系統</h1>
      <div className="ml-auto flex flex-wrap items-center gap-2">
        <div className="flex items-center rounded-xl border overflow-hidden">
          <button onClick={onPrevWeek} className="px-3 py-1 hover:bg-slate-100">← 上週</button>
          <div className="px-3 py-1 text-sm bg-slate-50 border-x">{label}</div>
          <button onClick={onNextWeek} className="px-3 py-1 hover:bg-slate-100">下週 →</button>
          <button onClick={onToday} className="px-3 py-1 hover:bg-slate-100">本週</button>
        </div>
        <select className="px-3 py-2 border rounded-xl bg-white" value={view} onChange={e=>setView(e.target.value)}>
          <option value="day">日視圖</option><option value="week">週視圖</option><option value="month">月視圖</option>
        </select>
        <select className="px-3 py-2 border rounded-xl bg-white" value={selectedInstr} onChange={e=>setSelectedInstr(e.target.value)}>
          {instruments.map(i=>(<option key={i.id} value={i.id}>{i.name}</option>))}
        </select>
        <Menu label={currentUser?.name || currentUser?.email}>
          <div className="px-3 py-1 text-xs text-slate-500">{currentUser.email}</div>
          {isAdmin && <AdminPanel users={users} onResetPwd={onResetPwd} onRemoveUser={onRemoveUser} />}
          <Menu.Separator />
          <Menu.Item onClick={onLogout}>登出</Menu.Item>
        </Menu>
        <Menu label="匯出/備份">
          <Menu.Item onClick={onExportCSV}>匯出 CSV（所有預約）</Menu.Item>
          <Menu.Item onClick={onExportJSON}>匯出 JSON 備份</Menu.Item>
          <Menu.Separator />
          <Menu.File onFile={onImportJSON}>匯入 JSON 備份</Menu.File>
        </Menu>
      </div>
    </div>
    <div className="bg-slate-50 border-t text-xs text-slate-600">
      <div className="max-w-7xl mx-auto px-4 py-2 flex items-center gap-4">
        <span>目前共有 {reservations.length} 筆預約</span>
        <span className="hidden sm:inline">（資料儲存在瀏覽器的 localStorage）</span>
      </div>
    </div>
  </header>);
}

function AdminPanel({ users, onResetPwd, onRemoveUser }){
  return (<div className="px-2 py-1">
    <div className="text-xs font-semibold px-3 py-1">帳號管理（管理員）</div>
    <div className="max-h-60 overflow-auto">
      {users.map(u=>(<div key={u.id} className="flex items-center gap-2 px-3 py-1 text-sm">
        <div className="flex-1"><div className="font-medium">{u.name} {u.isAdmin && <span className="text-xs text-emerald-600">(admin)</span>}</div><div className="text-xs text-slate-500">{u.email}</div></div>
        <button className="px-2 py-1 border rounded" onClick={()=>onResetPwd(u.id, prompt("新密碼：")||"temp1234")}>重設密碼</button>
        <button className="px-2 py-1 border rounded text-red-600" onClick={()=>onRemoveUser(u.id)}>刪除</button>
      </div>))}
    </div>
  </div>);
}

function QuickCreate({ instrument, initial, onClose, onSubmit }){
  const [form,setForm]=useState({ date:initial.date, start:initial.start, end:initial.end, user:"", email:"", title:\`\${instrument?.name||"儀器"} 使用\`, notes:"" });
  return (<div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50" onClick={onClose}>
    <div className="bg-white rounded-2xl w-full max-w-lg p-4" onClick={(e)=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-2"><h3 className="font-semibold">新增預約</h3><button className="px-2 py-1 text-sm border rounded-xl" onClick={onClose}>關閉</button></div>
      <div className="space-y-3 text-sm">
        <div className="grid grid-cols-2 gap-2">
          <div><label className="text-xs text-slate-600">日期</label><input type="date" className="w-full px-2 py-1 border rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} /></div>
          <div className="grid grid-cols-2 gap-2">
            <div><label className="text-xs text-slate-600">開始</label><input type="time" className="w-full px-2 py-1 border rounded" value={form.start} onChange={e=>setForm({...form, start:e.target.value})} /></div>
            <div><label className="text-xs text-slate-600">結束</label><input type="time" className="w-full px-2 py-1 border rounded" value={form.end} onChange={e=>setForm({...form, end:e.target.value})} /></div>
          </div>
        </div>
        <div><label className="text-xs text-slate-600">使用者</label><input className="w-full px-2 py-1 border rounded" value={form.user} onChange={e=>setForm({...form, user:e.target.value})} /></div>
        <div className="pt-2 flex items-center gap-2">
          <button className="px-3 py-2 border rounded-xl bg-slate-900 text-white disabled:opacity-50" onClick={()=> form.user.trim() && onSubmit({...form})} disabled={!form.user.trim()}>建立</button>
          <button className="px-3 py-2 border rounded-xl" onClick={()=>onClose()}>取消</button>
        </div>
      </div>
    </div>
  </div>);
}

function WeekCalendar({ weekDates, instrument, reservations, mapByDate, onCalendarClick, onDelete, onEdit, onExportICS }){
  const hours = Array.from({length:13},(_,i)=>8+i);
  const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  return (<div className="bg-white border rounded-2xl overflow-hidden">
    <div className="grid grid-cols-8 border-b bg-slate-50 text-sm">
      <div className="p-2 text-center text-slate-500">時間</div>
      {weekDates.map((d,idx)=>(<div key={idx} className="p-2 text-center font-medium">
        <div className="text-slate-500 text-xs">{weekdays[new Date(d).getDay()]}</div><div>{fmtDate(d)}</div>
      </div>))}
    </div>
    <div className="grid grid-cols-8 text-sm">
      <div className="border-r bg-slate-50 select-none">{hours.map(h=>(<div key={h} className="h-16 border-t px-2 py-1 text-right text-slate-500">{String(h).padStart(2,"0")}:00</div>))}</div>
      {weekDates.map((d,dayIdx)=>(<DayColumn key={dayIdx} dateISO={fmtDate(d)} reservations={mapByDate[fmtDate(d)]||[]} color={instrument?.color} onCalendarClick={onCalendarClick} onDelete={onDelete} onEdit={onEdit} onExportICS={onExportICS} />))}
    </div>
  </div>);
}
function DayColumn({ dateISO, reservations, color, onCalendarClick, onDelete, onEdit, onExportICS }){
  const hours = Array.from({length:13},(_,i)=>8+i);
  const ref = React.useRef(null);
  const handleClick = (e)=>{ const rect=ref.current.getBoundingClientRect(); const y=e.clientY-rect.top; const total=rect.height; let ratio=Math.max(0,Math.min(1,y/total)); onCalendarClick({dateISO, yRatio:ratio}); };
  return (<div className="border-l relative cursor-crosshair" ref={ref} onClick={handleClick}>
    {hours.map((h,i)=>(<div key={i} className="h-16 border-t"></div>))}
    <div className="absolute inset-0">
      {reservations.map(r=>(<BookingBlock key={r.id} reservation={r} color={color} onDelete={onDelete} onEdit={onEdit} onExportICS={()=>onExportICS(r)} />))}
    </div>
  </div>);
}
function BookingBlock({ reservation, color, onDelete, onEdit, onExportICS }){
  const top=((t2m(reservation.start)-8*60)/60)*64; const height=((t2m(reservation.end)-t2m(reservation.start))/60)*64;
  const style={ top:Math.max(0,top), height:Math.max(24,height), left:4, right:4, background:color };
  const [open,setOpen]=useState(false); const [editing,setEditing]=useState(false); const [draft,setDraft]=useState({...reservation});
  useEffect(()=> setDraft({...reservation}), [reservation]);
  const canDel = canDeleteReservation(getSession(), reservation.email);
  return (<div className="absolute rounded-xl shadow-md overflow-hidden cursor-pointer ring-1 ring-black/10" style={style} onClick={(e)=>{e.stopPropagation(); setOpen(true);}}>
    <div className="px-2 py-1 text-xs text-white/90"><div className="font-semibold truncate">{reservation.title||"已預約"}</div><div>{reservation.start}–{reservation.end} ・ {reservation.user}</div></div>
    {open && (<div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50" onClick={()=>setOpen(false)}>
      <div className="bg-white rounded-2xl w-full max-w-lg p-4" onClick={(e)=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-2"><h3 className="font-semibold">預約詳細</h3><button className="px-2 py-1 text-sm border rounded-xl" onClick={()=>setOpen(false)}>關閉</button></div>
        {!editing ? (<div className="space-y-2 text-sm">
          <KV label="日期" value={reservation.date} /><KV label="時間" value={`${reservation.start} ~ ${reservation.end}`} />
          <KV label="使用者" value={reservation.user} />{reservation.email && <KV label="Email" value={reservation.email} />}{reservation.title && <KV label="標題" value={reservation.title} />}{reservation.notes && <KV label="備註" value={reservation.notes} />}
          <div className="pt-2 flex flex-wrap gap-2">
            <button className="px-3 py-2 border rounded-xl" onClick={onExportICS}>加到行事曆 (.ics)</button>
            {canDel && <button className="px-3 py-2 border rounded-xl" onClick={()=>setEditing(true)}>編輯</button>}
            <div className="flex items-center gap-2 ml-auto">
              <button className={`px-3 py-2 border rounded-xl ${canDel?"text-red-600 hover:bg-red-50":"text-slate-400 cursor-not-allowed"}`} onClick={()=>canDel && onDelete(reservation.id)} disabled={!canDel} title={canDel?"刪除":"只有建立者或管理員可刪除"}>刪除</button>
            </div>
          </div>
        </div>) : (<div className="space-y-3 text-sm">
          <div className="grid grid-cols-2 gap-2"><div><label className="text-xs text-slate-600">日期</label><input type="date" className="w-full px-2 py-1 border rounded" value={draft.date} onChange={e=>setDraft({...draft,date:e.target.value})} /></div></div>
          <div className="grid grid-cols-2 gap-2"><div><label className="text-xs text-slate-600">開始</label><input type="time" className="w-full px-2 py-1 border rounded" value={draft.start} onChange={e=>setDraft({...draft,start:e.target.value})} /></div><div><label className="text-xs text-slate-600">結束</label><input type="time" className="w-full px-2 py-1 border rounded" value={draft.end} onChange={e=>setDraft({...draft,end:e.target.value})} /></div></div>
          <div className="grid grid-cols-2 gap-2"><div><label className="text-xs text-slate-600">使用者</label><input className="w-full px-2 py-1 border rounded" value={draft.user} onChange={e=>setDraft({...draft,user:e.target.value})} /></div><div><label className="text-xs text-slate-600">Email</label><input type="email" className="w-full px-2 py-1 border rounded" value={draft.email} onChange={e=>setDraft({...draft,email:e.target.value})} /></div></div>
          <div><label className="text-xs text-slate-600">標題</label><input className="w-full px-2 py-1 border rounded" value={draft.title} onChange={e=>setDraft({...draft,title:e.target.value})} /></div>
          <div><label className="text-xs text-slate-600">備註</label><textarea className="w-full px-2 py-1 border rounded" rows={3} value={draft.notes||""} onChange={e=>setDraft({...draft,notes:e.target.value})} /></div>
          <div className="pt-2 flex items-center gap-2"><button className="px-3 py-2 border rounded-xl bg-slate-900 text-white" onClick={()=>onEdit(reservation.id, draft)}>儲存</button><button className="px-3 py-2 border rounded-xl" onClick={()=>setEditing(false)}>取消</button></div>
        </div>)}
      </div>
    </div>)}
  </div>);
}
function KV({ label, value }){ return (<div className="grid grid-cols-3 gap-2"><div className="text-slate-500">{label}</div><div className="col-span-2 whitespace-pre-wrap">{value}</div></div>); }

function ToastCtx({ toast, onClose }){ if(!toast) return null; const bg=toast.type==="success"?"bg-emerald-600":toast.type==="error"?"bg-rose-600":"bg-slate-700"; useEffect(()=>{ const t=setTimeout(onClose,3000); return ()=>clearTimeout(t); },[onClose]); return (<div className={"fixed bottom-4 left-1/2 -translate-x-1/2 text-white px-4 py-2 rounded-xl shadow-lg "+bg}>{toast.msg}</div>); }
function Menu({ label, children }){ const [open,setOpen]=useState(false); useEffect(()=>{ const onDoc=()=>setOpen(false); if(open) document.addEventListener("click", onDoc); return ()=>document.removeEventListener("click", onDoc); },[open]); return (<div className="relative"><button className="px-3 py-2 border rounded-xl bg-white" onClick={(e)=>{e.stopPropagation(); setOpen(v=>!v);}}>{label}</button>{open && (<div className="absolute right-0 mt-2 w-72 bg-white border rounded-2xl shadow-lg p-1 z-50" onClick={(e)=>e.stopPropagation()}>{children}</div>)}</div>); }
Menu.Item=function MenuItem({children,onClick}){ return (<button className="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50" onClick={onClick}>{children}</button>); };
Menu.Separator=function Sep(){ return (<div className="my-1 border-t" />); };
Menu.File=function MenuFile({onFile,children}){ const inputRef=React.useRef(null); return (<div><button className="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50" onClick={()=>inputRef.current?.click()}>{children}</button><input ref={inputRef} type="file" accept="application/json" className="hidden" onChange={(e)=> e.target.files?.[0] && onFile(e.target.files[0]) } /></div>); };

function Footer(){ return (<footer className="text-center text-xs text-slate-500 py-6"><div>© {new Date().getFullYear()} Lab Booking. Demo 版（本機儲存）。</div><div>可選擇連接 Google Sheet（Apps Script）。</div></footer>); }

function DayCalendar({ date, instrument, reservations, onCalendarClick, onDelete, onEdit, onExportICS }){
  const dateISO=fmtDate(date); const hours=Array.from({length:13},(_,i)=>8+i); const ref=React.useRef(null);
  const handleClick=(e)=>{ const rect=ref.current.getBoundingClientRect(); const y=e.clientY-rect.top; const total=rect.height; let ratio=Math.max(0,Math.min(1,y/total)); onCalendarClick({dateISO, yRatio:ratio}); };
  const weekday=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][date.getDay()];
  return (<div className="bg-white border rounded-2xl overflow-hidden"><div className="border-b bg-slate-50 text-sm p-2 text-center font-medium"><div className="text-slate-500 text-xs">{weekday}</div><div>{dateISO}</div></div>
    <div className="grid grid-cols-7 text-sm"><div className="border-r bg-slate-50 select-none">{hours.map(h=>(<div key={h} className="h-16 border-t px-2 py-1 text-right text-slate-500">{String(h).padStart(2,"0")}:00</div>))}</div>
      <div className="col-span-6 border-l relative cursor-crosshair" ref={ref} onClick={handleClick}>{hours.map((_,i)=>(<div key={i} className="h-16 border-t"></div>))}
        <div className="absolute inset-0">{reservations.map(r=>(<BookingBlock key={r.id} reservation={r} color={instrument?.color} onDelete={onDelete} onEdit={onEdit} onExportICS={()=>onExportICS(r)} />))}</div>
      </div></div></div>);
}
function MonthCalendar({ anchor, instrument, reservations, onDayClick, onDelete, onEdit, onExportICS }){
  const start=new Date(anchor.getFullYear(), anchor.getMonth(), 1); const end=new Date(anchor.getFullYear(), anchor.getMonth()+1, 0);
  const firstWeekday=(start.getDay()+6)%7; const days=[]; for(let i=0;i<firstWeekday;i++) days.push(null); for(let d=1; d<=end.getDate(); d++) days.push(new Date(anchor.getFullYear(), anchor.getMonth(), d)); while(days.length%7!==0) days.push(null);
  const byDate={}; for(const r of reservations){ if(!byDate[r.date]) byDate[r.date]=[]; byDate[r.date].push(r); }
  return (<div className="bg-white border rounded-2xl overflow-hidden">
    <div className="grid grid-cols-7 bg-slate-50 border-b text-center text-sm">{["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((w,i)=>(<div key={i} className="p-2">{w}</div>))}</div>
    <div className="grid grid-cols-7">{days.map((d,idx)=>{ const dateISO=d?fmtDate(d):null; const items=dateISO?(byDate[dateISO]||[]):[]; return (<div key={idx} className={\`min-h-[120px] border p-2 \${d?"hover:bg-slate-50 cursor-pointer":"bg-slate-100"}\`} onClick={()=> d && onDayClick(dateISO)}>
      <div className="text-xs text-slate-500 mb-1">{d?d.getDate():""}</div>
      <div className="space-y-1">{items.slice(0,3).map(r=>(<div key={r.id} className="text-xs rounded px-2 py-1 text-white" style={{background: instrument?.color}}>{r.start}-{r.end} {r.user}</div>))}{items.length>3 && <div className="text-[10px] text-slate-500">+{items.length-3} 更多…</div>}</div>
    </div>); })}</div>
  </div>);
}

ReactDOM.createRoot(document.getElementById("root")).render(<BookingApp />);
    </script>
  </body>
</html>
