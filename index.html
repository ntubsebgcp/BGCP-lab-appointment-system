<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>蕭友晉老師實驗室儀器預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>html, body, #root { height: 100%; }</style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <!-- smoke test -->
    <script>
      document.title = '蕭友晉老師實驗室儀器預約系統';
    </script>
    <!-- Full App (inline JSX) -->
    <script type="text/babel" data-presets="env,react">
      const { useEffect, useMemo, useState } = React;
      const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
      const t2m=(t)=>{const [h,m]=t.split(':').map(Number);return h*60+m;};
      const m2t=(m)=>{const hh=Math.floor(m/60),mm=m%60;return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');};
      const isOverlap=(a1,a2,b1,b2)=>a1<b2&&b1<a2;
      const roundTo=(x,s=15)=>Math.round(x/s)*s;
      const clampTo=(a,b,min=8*60,max=20*60)=>[Math.max(min,a),Math.min(max,b)];
      const fmt=(d)=>{d=new Date(d);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');};
      const load=(k,fb)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):fb;}catch(e){return fb}};
      const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
      const ADMIN = new Set(["renyi0128@gmail.com","yshiau@g.ntu.edu.tw"].map(s=>s.toLowerCase()));
      function weakHash(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return (h>>>0).toString(16);}
      function getWeekStart(date){const d=new Date(date);const day=d.getDay();const diff=(day===0?-6:1)-day;d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
      function canDelete(currentUser, owner){if(!currentUser) return false; if(currentUser.isAdmin) return true; return (currentUser.email||'').toLowerCase()===(owner||'').toLowerCase();}
      function escICS(s){return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');}
      function exportICS(res, ins){const dtS=res.date.replace(/-/g,'')+'T'+res.start.replace(':','')+'00'; const dtE=res.date.replace(/-/g,'')+'T'+res.end.replace(':','')+'00'; const lines=[
        "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Lab Booking//EN","BEGIN:VEVENT",
        `UID:${res.id}@lab-booking`,`DTSTAMP:${dtS}Z`,`DTSTART:${dtS}`,`DTEND:${dtE}`,
        `SUMMARY:${escICS(res.title|| (ins?.name||'儀器')+' 預約')}`,
        `DESCRIPTION:${escICS('使用者: '+res.user+'\nEmail: '+(res.email||'')+'\n用途: '+(res.notes||''))}`,
        `LOCATION:${escICS(ins?.location||'實驗室')}`,"END:VEVENT","END:VCALENDAR"
      ].join("\n"); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([lines],{type:'text/calendar'})); a.download=`${ins?.name||'instrument'}-${res.date}-${res.start}.ics`; a.click(); }
      
      function App(){
        const [instruments,setInstruments]=useState(load('lab_instruments_v1',[
          {id:uid(), name:'GC', location:'漁科所406', color:'#a78bfa', maxMinutes:240},
          {id:uid(), name:'溫室氣體測量儀 (Innova 1512)', location:'水工所307B', color:'#34d399', maxMinutes:120},
        ]));
        const [reservations,setReservations]=useState(load('lab_reservations_v1',[]));
        const [selected,setSelected]=useState(instruments[0]?.id||'');
        const [weekStart,setWeekStart]=useState(getWeekStart(new Date()));
        const [view,setView]=useState('week');
        const [toast,setToast]=useState(null);
        const [quick,setQuick]=useState(null);
        const [user,setUser]=useState(load('lab_session_v1',null));
        const [users,setUsers]=useState(load('lab_users_v1',[]));
        useEffect(()=>save('lab_instruments_v1',instruments),[instruments]);
        useEffect(()=>save('lab_reservations_v1',reservations),[reservations]);
        useEffect(()=>save('lab_session_v1',user),[user]);
        useEffect(()=>save('lab_users_v1',users),[users]);
        useEffect(()=>{ if(!instruments.find(i=>i.id===selected)) setSelected(instruments[0]?.id||''); },[instruments,selected]);
        const weekDates=useMemo(()=>Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)),[weekStart]);
        const filtered=useMemo(()=>reservations.filter(r=>selected? r.instrumentId===selected: false).sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start)),[reservations,selected]);
        const mapByDate=useMemo(()=>{const m={}; for(const r of filtered){ (m[r.date]=m[r.date]||[]).push(r);} for(const k in m) m[k].sort((a,b)=>a.start.localeCompare(b.start)); return m;},[filtered]);
        const instr = instruments.find(i=>i.id===selected) || null;

        function addReservation(r){
          if(!user) return setToast({t:'error',m:'請先登入帳號'});
          r.email=user.email; r.user=r.user||user.name||user.email.split('@')[0];
          const ins=instruments.find(i=>i.id===r.instrumentId); if(!ins) return setToast({t:'error',m:'請先選擇儀器'});
          if(r.start>=r.end) return setToast({t:'error',m:'結束時間需晚於開始時間'});
          const dur=t2m(r.end)-t2m(r.start); if(ins.maxMinutes && dur>ins.maxMinutes) return setToast({t:'error',m:`此儀器單次最長 ${Math.round(ins.maxMinutes/60)} 小時`});
          const conflicts=reservations.filter(x=>x.instrumentId===r.instrumentId && x.date===r.date && isOverlap(t2m(x.start),t2m(x.end),t2m(r.start),t2m(r.end)));
          if(conflicts.length>0) return setToast({t:'error',m:'時間衝突，請改時段'});
          setReservations(prev=>[...prev,{...r,id:uid(),createdAt:new Date().toISOString()}]); setToast({t:'ok',m:'預約成功'});
        }
        function removeReservation(id){
          const tar=reservations.find(r=>r.id===id);
          if(!canDelete(user, tar?.email)) return setToast({t:'error',m:'只有建立者或管理員可刪除'});
          setReservations(prev=>prev.filter(r=>r.id!==id)); setToast({t:'ok',m:'已刪除預約'});
        }
        function editReservation(id,patch){
          const old=reservations.find(r=>r.id===id); if(!old) return;
          if(!canDelete(user,old.email)) return setToast({t:'error',m:'只有建立者或管理員可編輯'});
          const nxt={...old,...patch}; if(nxt.start>=nxt.end) return setToast({t:'error',m:'結束時間需晚於開始時間'});
          const ins=instruments.find(i=>i.id===nxt.instrumentId); const dur=t2m(nxt.end)-t2m(nxt.start);
          if(ins?.maxMinutes && dur>ins.maxMinutes) return setToast({t:'error',m:`此儀器單次最長 ${Math.round(ins.maxMinutes/60)} 小時`});
          const conflicts=reservations.filter(x=>x.id!==id && x.instrumentId===nxt.instrumentId && x.date===nxt.date && isOverlap(t2m(x.start),t2m(x.end),t2m(nxt.start),t2m(nxt.end)));
          if(conflicts.length>0) return setToast({t:'error',m:'時間衝突，請改時段'});
          setReservations(prev=>prev.map(r=>r.id===id?nxt:r)); setToast({t:'ok',m:'已更新預約'});
        }
        function onCalendarClick({dateISO,yRatio}){
          if(!selected) return setToast({t:'error',m:'請先選擇儀器'});
          const minutesFrom8=Math.floor(12*60*yRatio); let s=roundTo(8*60+minutesFrom8,15), e=s+60; [s,e]=clampTo(s,e); setQuick({date:dateISO,start:m2t(s),end:m2t(e)});
        }
        function registerDemo(){ // 簡化：建立一個本機帳號
          const email=prompt('你的 Email'); if(!email) return;
          const name=(email.split('@')[0]); const u={id:uid(), email:email.toLowerCase(), name, isAdmin: ADMIN.has(email.toLowerCase())};
          u.hash=weakHash('admin'); setUsers(prev=>[...prev,u]); setUser({id:u.id,email:u.email,name:u.name,isAdmin:u.isAdmin});
          setToast({t:'ok',m:'已建立並登入（demo 密碼 admin）'});
        }
        function loginDemo(){
          const email=prompt('Email'); const pass=prompt('密碼');
          const u=users.find(x=>x.email===String(email).toLowerCase()); if(!u||u.hash!==weakHash(pass)) return setToast({t:'error',m:'帳號或密碼錯誤'});
          setUser({id:u.id,email:u.email,name:u.name,isAdmin:u.isAdmin}); setToast({t:'ok',m:'登入成功'});
        }
        function logout(){ setUser(null); }

        const week = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        const hours = Array.from({length:13},(_,i)=>8+i);
        const instrObj=instruments.find(i=>i.id===selected);

        return (<div className="min-h-screen">
          <header className="bg-white border-b sticky top-0 z-40">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2">
              <h1 className="text-lg font-bold">蕭友晉老師實驗室儀器預約系統</h1>
              <div className="ml-auto flex items-center gap-2">
                {!user ? (<>
                  <button className="px-3 py-1 border rounded" onClick={registerDemo}>註冊(Demo)</button>
                  <button className="px-3 py-1 border rounded" onClick={loginDemo}>登入(Demo)</button>
                </>) : (<>
                  <span className="text-sm text-slate-600">{user.name} · {user.email}</span>
                  <button className="px-3 py-1 border rounded" onClick={logout}>登出</button>
                </>)}
                <select className="px-2 py-1 border rounded" value={view} onChange={e=>setView(e.target.value)}>
                  <option value="day">日視圖</option><option value="week">週視圖</option><option value="month">月視圖</option>
                </select>
                <select className="px-2 py-1 border rounded" value={selected} onChange={e=>setSelected(e.target.value)}>
                  {instruments.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}
                </select>
              </div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto p-4">
            {view==='week' && (<div className="bg-white border rounded-2xl overflow-hidden">
              <div className="grid grid-cols-8 border-b bg-slate-50 text-sm">
                <div className="p-2 text-center text-slate-500">時間</div>
                {Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)).map((d,idx)=>(
                  <div key={idx} className="p-2 text-center font-medium">
                    <div className="text-slate-500 text-xs">{week[d.getDay()]}</div>
                    <div>{fmt(d)}</div>
                  </div>
                ))}
              </div>
              <div className="grid grid-cols-8 text-sm">
                <div className="border-r bg-slate-50 select-none">
                  {hours.map(h=>(<div key={h} className="h-16 border-t px-2 py-1 text-right text-slate-500">{String(h).padStart(2,'0')}:00</div>))}
                </div>
                {Array.from({length:7},(_,i)=>new Date(weekStart.getTime()+i*86400000)).map((d,idx)=>{
                  const dateISO=fmt(d); const list=(mapByDate[dateISO]||[]);
                  return (<div key={idx} className="border-l relative cursor-crosshair" onClick={(e)=>{
                    const rect=e.currentTarget.getBoundingClientRect(); const y=e.clientY-rect.top; const ratio=Math.max(0,Math.min(1,y/rect.height)); onCalendarClick({dateISO,yRatio:ratio});
                  }}>
                    {hours.map((_,i)=>(<div key={i} className="h-16 border-t"></div>))}
                    <div className="absolute inset-0">
                      {list.map(r=>{
                        const top=((t2m(r.start)-8*60)/60)*64; const h=((t2m(r.end)-t2m(r.start))/60)*64;
                        return (<div key={r.id} className="absolute rounded-xl text-xs text-white p-1"
                          style={{top:Math.max(0,top),height:Math.max(24,h),left:4,right:4,background:instr?.color}}>
                          <div className="font-semibold truncate">{r.title||'已預約'}</div>
                          <div>{r.start}–{r.end} ・ {r.user}</div>
                          <div className="mt-1 flex gap-1">
                            <button className="px-2 py-0.5 border rounded bg-white/20" onClick={(ev)=>{ev.stopPropagation(); exportICS(r, instrObj);}}>ICS</button>
                            <button className="px-2 py-0.5 border rounded bg-white/20" onClick={(ev)=>{ev.stopPropagation(); removeReservation(r.id);}}>刪除</button>
                          </div>
                        </div>);
                      })}
                    </div>
                  </div>);
                })}
              </div>
            </div>)}
          </main>

          {quick && (<div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4" onClick={()=>setQuick(null)}>
            <div className="bg-white rounded-2xl w-full max-w-lg p-4" onClick={(e)=>e.stopPropagation()}>
              <div className="flex items-center justify-between mb-2"><h3 className="font-semibold">新增預約</h3><button className="px-2 py-1 text-sm border rounded" onClick={()=>setQuick(null)}>關閉</button></div>
              <Quick instrument={instr} initial={quick} onSubmit={(payload)=>{ addReservation({...payload, instrumentId:selected}); setQuick(null); }} />
            </div>
          </div>)}

          {toast && (<div className={"fixed bottom-4 left-1/2 -translate-x-1/2 text-white px-4 py-2 rounded "+(toast.t==='ok'?'bg-emerald-600':'bg-rose-600')}>
            {toast.m}
          </div>)}
        </div>);
      }

      function Quick({instrument, initial, onSubmit}){
        const [form,setForm]=useState({date:initial.date,start:initial.start,end:initial.end,user:"",email:"",title:`${instrument?.name||"儀器"} 使用`,notes:""});
        return (<div className="space-y-3 text-sm">
          <div className="grid grid-cols-2 gap-2">
            <div><label className="text-xs text-slate-600">日期</label><input type="date" className="w-full px-2 py-1 border rounded" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} /></div>
            <div className="grid grid-cols-2 gap-2">
              <div><label className="text-xs text-slate-600">開始</label><input type="time" className="w-full px-2 py-1 border rounded" value={form.start} onChange={e=>setForm({...form,start:e.target.value})} /></div>
              <div><label className="text-xs text-slate-600">結束</label><input type="time" className="w-full px-2 py-1 border rounded" value={form.end} onChange={e=>setForm({...form,end:e.target.value})} /></div>
            </div>
          </div>
          <div><label className="text-xs text-slate-600">使用者</label><input className="w-full px-2 py-1 border rounded" value={form.user} onChange={e=>setForm({...form,user:e.target.value})} /></div>
          <div className="pt-2 flex items-center gap-2"><button className="px-3 py-2 border rounded bg-slate-900 text-white" onClick={()=>form.user.trim()&&onSubmit({...form})} disabled={!form.user.trim()}>建立</button></div>
        </div>);
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
