<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register Test</title>
  <script>
    // 把你的最新版 Web App URL 放這裡（一定是 /exec，不是 /dev）
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyfOv6lZ4MMxpHQLFnP5p-g3Ll6-HL6gDe72IKC2WO2XzraA_PqdxIIf4ogL7epjp4vFA/exec";
    async function health(){
      try{
        const u = GAS_WEBAPP_URL + "?action=health";
        const r = await fetch(u);
        const j = await r.json();
        console.log("[health]", j);
        document.getElementById("health").textContent = JSON.stringify(j, null, 2);
      }catch(e){
        document.getElementById("health").textContent = "Health error: " + e;
      }
    }
    function randomSalt(n=16){
      const a=new Uint8Array(n); crypto.getRandomValues(a);
      return [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    async function sha256Hex(str){
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    async function apiRegisterToSheet({name,email,password}){
      const salt = randomSalt();
      const hash = await sha256Hex(password + ":" + salt);
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action:"register", name, email, salt, hash })
      });
      const data = await res.json();
      console.log("[register] status", res.status, data);
      return data;
    }
    async function doRegister(){
      const email = document.getElementById("email").value.trim().toLowerCase();
      const name  = document.getElementById("name").value.trim() || email.split("@")[0];
      const pass  = document.getElementById("pass").value.trim() || "admin";
      const out   = document.getElementById("out");
      const r = await apiRegisterToSheet({name,email,password:pass});
      out.textContent = JSON.stringify(r, null, 2);
    }
    window.addEventListener("load", health);
  </script>
  <style>
    body{font-family:system-ui,Arial;padding:16px;max-width:720px;margin:auto}
    input{padding:8px;margin:4px 0;width:100%}
    button{padding:8px 12px}
    pre{background:#f6f8fa;padding:12px;border:1px solid #ddd;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
  <h1>Register Test</h1>

  <h3>Health (GET ?action=health)</h3>
  <pre id="health">loading…</pre>

  <h3>Register</h3>
  <input id="email" placeholder="email@example.com">
  <input id="name"  placeholder="name (optional)">
  <input id="pass"  placeholder="password (optional, default admin)">
  <button onclick="doRegister()">Register</button>

  <h3>Server response</h3>
  <pre id="out"></pre>
</body>
</html>
